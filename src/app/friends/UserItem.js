"use client";

import { postData } from "@/services/API";
import { useUser } from "@/store/useUser";
import { Spinner } from "@heroui/react";
import { useMutation } from "@tanstack/react-query";
import Image from "next/image";
import React, { useEffect, useState } from "react";

const fetchData = async ({ senderId, receiverId }) => {
  const res = await fetch("/api/friends/send-friendship-request", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ senderId, receiverId }),
  });

  if (!res.ok) throw new Error("مشکلی پیش آمد!");

  return res.json();
};

const UserItem = ({ userInfo }) => {
  const { user } = useUser();
  const { data, mutate, isPending, error } = useMutation({
    mutationFn: fetchData,
  });

  const sendFriendshipRequestHandler = () => {
    mutate({ senderId: user._id, receiverId: userInfo._id });
  };

  return (
    <div className="relative w-full rounded-2xl p-[1px] bg-gradient-to-b from-blueColor/30 via-blueColor/10 to-transparent group hover:from-blueColor/40 hover:via-blueColor/15 transition-all duration-300">
      <div className="relative flex items-center justify-between gap-3 rounded-2xl bg-secondaryDarkTheme/80 backdrop-blur-sm p-4">
        {/* User Info */}
        <div className="flex items-center gap-3 flex-1 min-w-0">
          <div className="relative flex-shrink-0">
            <div className="absolute -inset-1 rounded-xl bg-blueColor/20 blur-md group-hover:bg-blueColor/30 transition-colors" />
        <Image
          src={"/avatar.png"}
          width={50}
          height={50}
              className="relative size-12 rounded-xl object-cover border-2 border-white/10"
          alt={`کاربر ${userInfo.nickName}`}
        />
          </div>

          <div className="flex-1 flex flex-col gap-0.5 min-w-0">
            <span className="text-sm font-semibold text-white truncate">
              {userInfo.nickName}
            </span>
            <span className="text-xs text-blueColor font-medium">
              {userInfo.userName}@
          </span>
        </div>
      </div>

        {/* Status/Action */}
        <div className="flex-shrink-0">
      {userInfo?.friendshipStatus === "accepted" ? (
            <span className="text-xs text-emerald-300 px-2 py-1 rounded-lg bg-emerald-500/10 border border-emerald-400/30">
              دوست
            </span>
      ) : userInfo?.friendshipStatus === "pending" ? (
            <span className="text-xs text-yellow-300 px-2 py-1 rounded-lg bg-yellow-500/10 border border-yellow-400/30">
              در انتظار
            </span>
      ) : data?.message ? (
            <span className="text-xs text-emerald-300 px-2 py-1 rounded-lg bg-emerald-500/10 border border-emerald-400/30">
              {data.message}
            </span>
      ) : (
        <button
          onClick={sendFriendshipRequestHandler}
          disabled={isPending}
              className="px-3 py-1.5 text-xs flex items-center gap-1.5 bg-blueColor/10 border border-blueColor/30 text-blueColor rounded-lg hover:bg-blueColor/20 transition-colors font-medium disabled:opacity-50"
        >
          {isPending ? (
            <Spinner
              size="sm"
              classNames={{
                circle1: "border-b-blueColor",
                circle2: "border-b-blueColor",
              }}
            />
          ) : (
                <>
            <svg
              xmlns="http://www.w3.org/2000/svg"
                    width={14}
                    height={14}
              viewBox="0 0 16 16"
            >
              <path
                d="M5.632 0.5856480000000001C5.16288 0.640912 4.886992 0.700352 4.6000000000000005 0.808016C3.716 1.139616 3.082192 1.8487360000000002 2.8336 2.784256C2.729264 3.1769119999999997 2.7128159999999997 3.3294720000000004 2.7128159999999997 3.904C2.7128159999999997 4.478528000000001 2.729264 4.631088 2.8336 5.023744C3.11664 6.088896 3.881456 6.838512 4.965712000000001 7.113472C5.243712 7.183952000000001 5.516768 7.217664 5.88816 7.227312C7.01712 7.2566880000000005 7.84192 6.974768 8.472016 6.344176000000001C8.705664 6.110336 8.843744000000001 5.91904 8.991824000000001 5.6240000000000006C9.167136000000001 5.27472 9.275136 4.90016 9.330928 4.448C9.357808 4.23024 9.357808 3.5777600000000005 9.330928 3.36C9.255840000000001 2.751504 9.065664000000002 2.223856 8.771536000000001 1.808C8.639984 1.622 8.325712 1.3044000000000002 8.149856 1.179744C7.719056 0.874368 7.27672 0.7040320000000001 6.68072 0.614016C6.527072 0.590816 5.763520000000001 0.57016 5.632 0.5856480000000001M5.736 1.7301600000000001C4.8961760000000005 1.789696 4.309328000000001 2.159152 4.039904 2.797984C3.839728 3.272624 3.784192 3.9509760000000003 3.8976 4.5360000000000005C4.038848 5.2646239999999995 4.432288 5.733392 5.086304 5.952319999999999C5.619808 6.130928 6.418128 6.133712000000001 6.954048 5.958848C7.35536 5.827904 7.659984000000001 5.603072 7.867552 5.2846400000000004C8.013344 5.060992000000001 8.11136 4.8010720000000005 8.171024000000001 4.48C8.212608 4.256144 8.212112 3.5643200000000004 8.170208 3.3280000000000003C8.015616 2.45648 7.519728000000001 1.9442080000000002 6.668208 1.776384C6.510368000000001 1.74528 6.125152 1.7099680000000002 5.992 1.714416C5.9568 1.715584 5.841600000000001 1.722672 5.736 1.7301600000000001M10.741935999999999 6.816544C10.2712 6.839968 10.016672000000002 6.886768 9.819088 6.9862079999999995C9.479536 7.157072 9.18272 7.486832000000001 9.057856 7.831904000000001C8.97672 8.056128 8.957647999999999 8.184496000000001 8.94816 8.570368L8.939456 8.924752 8.657727999999999 8.934048C8.26024 8.947168 8.075568 8.967856 7.919568 9.016784C7.490496 9.151312 7.10904 9.493024 6.950912000000001 9.884528000000001C6.8650720000000005 10.097008 6.84184 10.247776 6.815008 10.766352000000001C6.787392 11.299968000000002 6.82304 11.91376 6.897808 12.192C7.0248800000000005 12.664848000000001 7.444432 13.078784 7.9430879999999995 13.223296000000001C8.11528 13.273183999999999 8.336575999999999 13.296000000000001 8.648384 13.296000000000001C8.783136 13.296000000000001 8.904768 13.300368 8.918688 13.305712C8.94 13.313888 8.944 13.348864 8.944 13.527392C8.944 13.8436 8.97088 14.122736000000002 9.016464000000001 14.28008C9.166943999999999 14.799328 9.592272000000001 15.220304 10.091296 15.343936C10.51264 15.44832 11.752976 15.44792 12.162832 15.343280000000002C12.683264 15.2104 13.104000000000001 14.7788 13.250288000000001 14.227727999999999C13.275536 14.132656 13.287408 14.011376 13.301568 13.704L13.32 13.304 13.672 13.293600000000001C13.88976 13.287184 14.073456 13.273376 14.153712 13.257424C14.51736 13.185120000000001 14.883008 12.954112 15.10256 12.657952C15.204848 12.519968 15.302688 12.315232 15.344336 12.152000000000001C15.444544 11.759296 15.448624 10.491072 15.350912000000001 10.105680000000001C15.274624 9.804816 15.153632 9.599408 14.925056000000001 9.382672000000001C14.715152 9.183648 14.505776000000001 9.065376 14.244288000000001 8.998096C14.096176 8.959984 13.74448 8.930912000000001 13.404 8.928624L13.312000000000001 8.928 13.311424 8.78C13.310255999999999 8.48568 13.280976 8.121296000000001 13.248096 7.992C13.140944 7.5706880000000005 12.824160000000001 7.1823999999999995 12.421152000000001 6.978368000000001C12.29072 6.912336000000001 12.081520000000001 6.864064000000001 11.825216000000001 6.840864C11.491376 6.81064 11.05672 6.80088 10.741935999999999 6.816544M10.6 7.9698720000000005C10.369824000000001 7.98928 10.308912000000001 8.009536 10.223424000000001 8.095184C10.105167999999999 8.213664000000001 10.100064 8.245072 10.080879999999999 8.971424C10.066176 9.528032 10.060816 9.608032 10.033328 9.680368000000001C9.976592 9.829711999999999 9.880144 9.9324 9.728624 10.004783999999999L9.625248 10.054176 9.056624 10.067103999999999C8.743872 10.074224000000001 8.431263999999999 10.087104 8.36192 10.095728C8.169008 10.119712 8.047936 10.206064000000001 8.002544 10.352C7.9364799999999995 10.564448 7.936736 11.675120000000001 8.002896 11.886096C8.025136 11.957024 8.11736 12.057744000000001 8.198912 12.100208C8.268559999999999 12.136464 8.312208 12.139392 9.272 12.172495999999999C9.622048000000001 12.184576 9.644448 12.187248 9.731136000000001 12.227312C9.847376 12.28104 9.958896000000001 12.392528 10.012752 12.508863999999999C10.060080000000001 12.611072 10.068048000000001 12.71352 10.092048 13.528C10.104048 13.935296000000001 10.105200000000002 13.94584 10.147376000000001 14.032C10.201136 14.141824000000002 10.294544 14.216624 10.405968000000001 14.239088C10.57184 14.272544 11.106192 14.289520000000001 11.443648 14.272048000000002C11.862304 14.250399999999999 11.92096 14.238528 12.008624 14.157712C12.04632 14.122959999999999 12.093072000000001 14.060704 12.112512 14.01936C12.152512000000002 13.934256 12.154 13.912848 12.174864 13.128C12.186879999999999 12.675728 12.191120000000002 12.623952 12.22288 12.540768C12.270992 12.414816000000002 12.377776 12.300944 12.507871999999999 12.236896000000002L12.613664000000002 12.184816000000001 12.974832000000001 12.172304C13.989456 12.137152 13.951824 12.140176 14.048672000000002 12.08608C14.149088 12.030000000000001 14.230191999999999 11.924128000000001 14.245120000000002 11.829647999999999C14.275472 11.637360000000001 14.289968000000002 11.09552 14.273072 10.784432C14.263264 10.603792 14.250928 10.4344 14.245664000000001 10.408C14.220736 10.28296 14.137088 10.18368 14.008000000000001 10.125904C13.932288000000002 10.092016 13.898031999999999 10.089407999999999 13.368 10.076944C12.730736 10.061952 12.609376000000001 10.050848 12.502736 9.997792C12.404352000000001 9.948848 12.297184 9.841040000000001 12.245488 9.739023999999999C12.191776 9.633040000000001 12.17928 9.494128000000002 12.163168 8.824C12.151584000000001 8.34224 12.147616000000001 8.289696 12.117776 8.224C12.036384 8.044848 11.960111999999999 8.002064 11.672 7.973984000000001C11.440336 7.951408000000001 10.846224000000001 7.949136 10.6 7.9698720000000005M5.2234560000000005 8.200784C3.91104 8.328544 2.614448 8.785088 1.5406400000000002 9.497504000000001C0.884432 9.932864 0.57672 10.450032 0.5752480000000001 11.120000000000001C0.574144 11.62504 0.778544 12.090944 1.17568 12.488512C1.583808 12.897088 2.095056 13.13608 2.6992800000000003 13.200752000000001C2.7986880000000003 13.211392 3.2977440000000002 13.215776 4.064 13.212768L5.272 13.208 5.363136000000001 13.165280000000001C5.474992 13.112848 5.583648 13.006848 5.641856 12.893407999999999C5.704752000000001 12.7708 5.713952 12.575488 5.663184 12.440784C5.613536 12.309072 5.468144000000001 12.162128000000001 5.336 12.110128000000001L5.24 12.072336 3.968 12.063248C3.2684 12.05824 2.678 12.048496 2.656 12.041568C2.634 12.034656000000002 2.5692 12.014272000000002 2.512 11.996255999999999C2.1884479999999997 11.894352000000001 1.9320640000000002 11.690352 1.8025440000000001 11.431744C1.6148959999999999 11.057024 1.733264 10.737296 2.1645920000000003 10.45376C3.102848 9.837040000000002 4.125088 9.47416 5.28856 9.344816000000002C5.44728 9.327168 5.60208 9.304224 5.632560000000001 9.293824C5.753520000000001 9.252576 5.892384 9.126128000000001 5.957376 8.998016C5.971328000000001 8.970512000000001 5.990224 8.901247999999999 5.999344 8.84408C6.0386560000000005 8.598032 5.919488 8.361248 5.700512 8.250288000000001C5.631328000000001 8.215232 5.5940959999999995 8.204992 5.464 8.185312C5.4464 8.182656 5.33816 8.189616000000001 5.2234560000000005 8.200784"
                stroke="none"
                fill="currentColor"
                fillRule="evenodd"
                strokeWidth={0.016}
              />
            </svg>
                  افزودن
                </>
          )}
        </button>
      )}
        </div>
      </div>
    </div>
  );
};

export default UserItem;
